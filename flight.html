<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FocusFlight (Earth & Stars)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet" />

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    body { font-family:'Inter',sans-serif; }

    /* Fullscreen Three.js canvas */
    #globe-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }

    /* Transparent UI screens over globe */
    .screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      z-index: 2;
      background: transparent;
    }
    .screen.active { display: flex; }

    /* Leaflet map overlay */
    #map {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 3;
    }
    .ui-overlay { z-index: 4; }

    .barcode { font-family:'Libre Barcode 39 Text',cursive; font-size:60px; color:#E5E7EB; text-align:center; white-space:nowrap; }
    @keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:.5 } }
    .animate-pulse-slow { animation: pulse 3s ease-in-out infinite }
    @keyframes pulse-marker {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(251,191,36,0.7) }
      70% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(251,191,36,0) }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(251,191,36,0) }
    }
    .pulse-marker {
      background:#fbbf24; border-radius:50%; width:15px; height:15px; border:2px solid #fff; animation:pulse-marker 2s infinite;
    }
    .leaflet-marker-icon.airplane-marker { transition:none!important; will-change:transform; }
  </style>
</head>
<body>
  <!-- Three.js Globe Canvas -->
  <div id="globe-container"></div>

  <!-- SETUP SCREEN -->
  <div id="setup-screen" class="screen flex flex-col items-center justify-center p-8 gap-6">
    <h1 class="text-white text-3xl sm:text-4xl font-bold">Set Your Destination</h1>
    <p class="text-gray-400">Rotate the globe to select Departure & Arrival.</p>
    <div id="globe-inner" class="w-full max-w-2xl aspect-square rounded-lg"></div>
    <div class="flex justify-between w-full max-w-2xl">
      <div class="text-center"><p class="text-gray-400">DEPARTURE</p><p id="departure-text" class="text-white text-2xl font-bold">- - -</p></div>
      <div class="text-center"><p class="text-gray-400">ARRIVAL</p><p id="arrival-text" class="text-white text-2xl font-bold">- - -</p></div>
    </div>
    <div class="w-full max-w-md">
      <label class="block text-center text-gray-400 mb-2">Flight Time: <span id="duration-label" class="text-white font-bold">60</span> minutes</label>
      <input id="duration-slider" type="range" min="15" max="180" value="60" step="5" class="w-full h-2 bg-gray-700 rounded-lg cursor-pointer" />
    </div>
    <button id="confirm-flight-btn" disabled class="bg-amber-500 text-gray-900 py-3 px-12 rounded-lg font-bold disabled:bg-gray-600 disabled:cursor-not-allowed hover:bg-amber-400">Generate Boarding Pass</button>
    <button id="logbook-btn" class="absolute top-4 right-4 bg-gray-700/50 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-600/50">Logbook</button>
  </div>

  <!-- BOARDING, FOCUS, SUMMARY, LOGBOOK Screens... reuse your existing markup here -->

  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
  <script type="importmap">
    {"imports":{
      "three":"https://unpkg.com/three@0.157.0/build/three.module.js",
      "three/addons/":"https://unpkg.com/three@0.157.0/examples/jsm/"
    }}
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // City data
    const cities = [
      {name:"New York",code:"JFK",lat:40.64,lon:-73.77},
      {name:"Los Angeles",code:"LAX",lat:33.94,lon:-118.40},
      {name:"Chicago",code:"ORD",lat:41.97,lon:-87.90},
      {name:"Toronto",code:"YYZ",lat:43.67,lon:-79.62},
      {name:"Mexico City",code:"MEX",lat:19.43,lon:-99.07},
      {name:"Vancouver",code:"YVR",lat:49.19,lon:-123.18},
      {name:"São Paulo",code:"GRU",lat:-23.43,lon:-46.47},
      {name:"Buenos Aires",code:"EZE",lat:-34.82,lon:-58.53},
      {name:"Bogotá",code:"BOG",lat:4.70,lon:-74.14},
      {name:"Lima",code:"LIM",lat:-12.02,lon:-77.11},
      {name:"Rio de Janeiro",code:"GIG",lat:-22.81,lon:-43.25},
      {name:"London",code:"LHR",lat:51.47,lon:-0.45},
      {name:"Paris",code:"CDG",lat:49.00,lon:2.59},
      {name:"Istanbul",code:"IST",lat:41.27,lon:28.75},
      {name:"Amsterdam",code:"AMS",lat:52.31,lon:4.76},
      {name:"Frankfurt",code:"FRA",lat:50.03,lon:8.56},
      {name:"Madrid",code:"MAD",lat:40.49,lon:-3.56},
      {name:"Rome",code:"FCO",lat:41.80,lon:12.23},
      {name:"Tokyo",code:"HND",lat:35.54,lon:139.77},
      {name:"Dubai",code:"DXB",lat:25.25,lon:55.36},
      {name:"Singapore",code:"SIN",lat:1.36,lon:103.99},
      {name:"Hong Kong",code:"HKG",lat:22.30,lon:113.91},
      {name:"Shanghai",code:"PVG",lat:31.14,lon:121.80},
      {name:"Seoul",code:"ICN",lat:37.46,lon:126.44},
      {name:"Doha",code:"DOH",lat:25.27,lon:51.56},
      {name:"Bangkok",code:"BKK",lat:13.69,lon:100.75},
      {name:"Mumbai",code:"BOM",lat:19.08,lon:72.86},
      {name:"Delhi",code:"DEL",lat:28.55,lon:77.10},
      {name:"Beijing",code:"PEK",lat:40.08,lon:116.58},
      {name:"Hosur", code:"HSR",lat:12.74,lon:77.82},
      {name:"Cairo", code:"CAI",lat:30.11,lon:31.40},
      {name:"Johannesburg",code:"JNB",lat:-26.13,lon:28.24},
      {name:"Lagos", code:"LOS",lat:6.57,lon:3.32},
      {name:"Nairobi",code:"NBO",lat:-1.33,lon:36.92},
      {name:"Addis Ababa",code:"ADD",lat:8.97,lon:38.79},
      {name:"Sydney", code:"SYD",lat:-33.94,lon:151.17},
      {name:"Melbourne",code:"MEL",lat:-37.66,lon:144.84},
      {name:"Auckland", code:"AKL",lat:-37.00,lon:174.78}
    ];

    // State & screens
    const state = {currentScreen:'setup',departureCity:null,arrivalCity:null,durationMinutes:60,flightLog:JSON.parse(localStorage.getItem('flightLog'))||[],globeInit:false,flightDistance:0,timer:null,flightAnim:null};
    const screens = {
      setup:document.getElementById('setup-screen'),
      boarding:document.getElementById('boarding-screen'),
      focus:document.getElementById('focus-screen'),
      summary:document.getElementById('summary-screen'),
      logbook:document.getElementById('logbook-screen')
    };

    // Three.js globe init
    const globeContainer = document.getElementById('globe-container');
    const globeInner = document.getElementById('globe-inner');
    let scene,camera,renderer,controls,earth,starSphere,raycaster,mouse,cityGroup=new THREE.Group();

    function latLonToVec(lat,lon,r=1){
      const phi=(90-lat)*Math.PI/180,theta=(lon+180)*Math.PI/180;
      return new THREE.Vector3(-r*Math.sin(phi)*Math.cos(theta),r*Math.cos(phi),r*Math.sin(phi)*Math.sin(theta));
    }

    function initGlobe(){
      if(state.globeInit) return;
      scene=new THREE.Scene();
      camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,2000);camera.position.z=2.5;
      renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});renderer.setSize(window.innerWidth,window.innerHeight);renderer.setPixelRatio(window.devicePixelRatio);globeContainer.appendChild(renderer.domElement);

      controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=true;controls.dampingFactor=0.05;controls.enablePan=false;controls.minDistance=1.5;controls.maxDistance=5;

      scene.add(new THREE.AmbientLight(0x404040,2));const dl=new THREE.DirectionalLight(0xffffff,1);dl.position.set(5,3,5);scene.add(dl);

      const loader=new THREE.TextureLoader();
      const earthMap=loader.load('https://www.solarsystemscope.com/textures/download/2k_earth_daymap.jpg');
      earth=new THREE.Mesh(new THREE.SphereGeometry(1,64,64),new THREE.MeshPhongMaterial({map:earthMap,shininess:5}));
      scene.add(earth);

      const starMap=loader.load('https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Milky_Way_Night_Sky_Black_Rock_Desert_Nevada.jpg/2560px-Milky_Way_Night_Sky_Black_Rock_Desert_Nevada.jpg');
      starSphere=new THREE.Mesh(new THREE.SphereGeometry(80,64,64),new THREE.MeshBasicMaterial({map:starMap,side:THREE.BackSide}));
      scene.add(starSphere);

      cities.forEach(c=>{
        const m=new THREE.Mesh(new THREE.SphereGeometry(0.008,16,16),new THREE.MeshBasicMaterial({color:0xFBBF24}));
        m.position.copy(latLonToVec(c.lat,c.lon,1));m.userData=c;cityGroup.add(m);
      });
      earth.add(cityGroup);

      raycaster=new THREE.Raycaster();mouse=new THREE.Vector2();
      globeInner.addEventListener('click',onGlobeClick);

      window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});

      (function animate(){controls.update();renderer.render(scene,camera);requestAnimationFrame(animate)})();
      state.globeInit=true;
    }

    function onGlobeClick(e){
      const rect=globeInner.getBoundingClientRect();
      mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
      mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
      raycaster.setFromCamera(mouse,camera);
      const hits=raycaster.intersectObjects(cityGroup.children);
      if(hits.length) handleCityClick(hits[0].object.userData);
    }

    // Visibility and flight logic
    initGlobe(); navigateTo('setup');

    // Implement handleCityClick, updateUI, setupBoardingPass, startFlight, endFlight, navigateTo, showLogbook exactly as before

  </script>
</body>
</html>
